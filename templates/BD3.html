<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>WhaleSignal Music Platform Analytics</title>
  <!-- è¼‰å…¥ Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- å¼•ç”¨ CSS (æ”¾åœ¨ static ç›®éŒ„) -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/BD.css') }}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Michroma&family=Rajdhani:wght@300;400;500;600;700&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/analysis.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
  <link rel="icon" type="image/png"
    href="{{ url_for('static', filename='image/WhaleSignal_Logo-r(1).png') }}">
  <style>
    /* çµ±ä¸€å®¹å™¨å¤§å° */
    .chart-container {
      display: inline-block;
      vertical-align: top;
      box-sizing: border-box;
    }

    /*     
    .header {
      text-align: center;
      font-size: 1.5em;
      margin-bottom: 20px;
    }
    .full-width {
      width: 90%;
      margin: 2% auto;
    }
    #scenarioText, .Comment {
      font-size: 1.2em;
      text-align: center;
      padding: 10px;
    } */
  </style>
</head>

<body class="bc54">
  <div id="header-info" class="header-info d-flex align-items-center">
    <a href="http://127.0.0.1:5000/analysis" id="analysis" class="shape-ex2 m-3 Rajdhani text-shadow">analysis
      <div class="shape-line"></div>
    </a>
    <a href="http://127.0.0.1:5000/pay" id="premium" class="shape-ex2 m-3 Rajdhani text-shadow">premium
      <div class="shape-line"></div>
    </a>
    <a href="http://127.0.0.1:5000/log_in" id="user" class="user d-flex align-items-center text-shadow">
      <div  class="user-account shape-ex2 m-3 Rajdhani">
        login
        <div class="shape-line"></div>
      </div>
      <img id="user-img" src="https://cdn-icons-png.flaticon.com/512/1144/1144760.png" alt="" class="user-img">
    </a>
  </div>
  <header id="header" class="header bc23 d-flex justify-content-between color1 show-header">
    <div id="logo-block" class="header-logo d-flex align-items-center">
      <a href="http://127.0.0.1:5000/" class="logo d-flex align-items-center">
        <!-- Flask url_for å¼•ç”¨ static è£¡çš„ image_19.png -->
        <img id="logo-img" class="logo-img m-2"
          src="{{url_for('static', filename='image/WhaleSignal_Logo-r(1).png')}}"
          alt="">
        <div id="logo-name" class="logo-text m-2 Michroma">WhaleSignal</div>
      </a>
    </div>
        <!-- ğŸ”½ æ–°å¢æ¼¢å ¡é¸å–® -->
    <label id="menu-toggle" class="menu-toggle" for="check">
      <input type="checkbox" id="check"/> 
      <span></span>
      <span></span>
      <span></span>
    </label>

    <div id="header-info2">
      <a href="http://127.0.0.1:5000/analysis" id="analysis" class="shape-ex2 m-3 Rajdhan text-shadow">
        analysis
        <div class="shape-line"></div>
      </a>
      <a href="http://127.0.0.1:5000/pay" id="premium" class="shape-ex2 m-3 Rajdhani text-shadow">
        premium
        <div class="shape-line"></div>
      </a>
      <a href="http://127.0.0.1:5000/log_in" id="user" class="user d-flex align-items-center text-shadow">
        <div class="user-account shape-ex2 m-3 Rajdhani">
          login
            <div class="shape-line" ></div>
        </div>
        <img id="user-img" src="https://cdn-icons-png.flaticon.com/512/1144/1144760.png" alt="" class="user-img">
      </a>
    </div>
  </header>
  <div class="header-height"></div>

  <div class="main-content">
    <button class="history-btn" id="toggleHistory"><img src="{{ url_for('static', filename='image/list_icon.png') }}"
        alt=""></button>

    <div class="history-panel" id="historyPanel">
      <h3>Archived Records</h3>
      <ul>
        {% for record in history_records %}
        <li> 
          <button class="history-item" onclick="redirectToAnalysis({{ record.id }})">
            {{record.id}} - {{ record.song_name }} ({{ record.upload_time }})
          </button>
        </li>
        {% endfor %}
      </ul>
    </div>
    <!-- å¹³å°åˆ‡æ›æŒ‰éˆ• -->
    <div class="analysis-btn-container  d-flex justify-content-center flex-wrap gap-3 color1">
      <div class="btn-block full-width d-flex justify-content-center">
        <!-- é è¨­ Youtube ç‚º active -->
        <div class="yt-btn-block yt-btn d-flex justify-content-center align-items-center active"
          data-platform="youtube">
          <div class="switch-btn yt-btn">
            <img src="https://cdn-icons-png.flaticon.com/512/3670/3670147.png" alt="">
          </div>
          <span class="btn-text">Youtube</span>
        </div>
        <div class="yt-btn-block sptf-btn d-flex justify-content-center align-items-center" data-platform="spotify">
          <div class="switch-btn sptf-btn">
            <img src="https://cdn-icons-png.flaticon.com/512/174/174872.png" alt="">
          </div>
          <span class="btn-text">Spotify</span>
        </div>
        <div class="yt-btn-block am-btn d-flex justify-content-center align-items-center" data-platform="apple-music">
          <div class="switch-btn am-btn">
            <img
              src="https://cdn.iconscout.com/icon/free/png-256/free-apple-music-icon-download-in-svg-png-gif-file-formats--itunes-app-ios-ios14-14-pack-user-interface-icons-2365226.png"
              alt="">
          </div>
          <span class="btn-text">Apple Music</span>
        </div>
        <div class="yt-btn-block tidal-btn d-flex justify-content-center align-items-center" data-platform="tidal">
          <div class="switch-btn tidal-btn">
            <img src="https://cdn-icons-png.flaticon.com/512/16592/16592443.png" alt="">
          </div>
          <span class="btn-text">TIDAL</span>
        </div>
        <div class="yt-btn-block amazon-btn d-flex justify-content-center align-items-center"
          data-platform="amazon-music">
          <div class="switch-btn amazon-btn">
            <img class="amazon" src="https://img.icons8.com/?size=512&id=lxwUaALAeQmr&format=png" alt="">
          </div>
          <span class="btn-text">Amazon Music</span>
        </div>
      </div>
    </div>
<!-- menu -->
<script>
  document.getElementById("check").addEventListener("change", function () {
  document.getElementById("header-info").classList.toggle("active");
  });
</script>

    <!-- å„å¹³å°åˆ†æå…§å®¹ -->
    <div class="analysis-btn-container color1">
      <!-- Youtube å€å¡Š -->
      <div class="analysis-content active" data-platform="youtube">
        <div class="d-flex  flex-wrap color1 align-items-center justify-content-center">
          {% if latest_song.fame_indicator == "æœƒç´…å–”!" %}
          <div id="youtube-info" class=" chart info-container">
            <div class="h50p">
              <p class="large-number">{{ latest_song.trending_days }}</p>
              <p class="description">days to 1 million views</p>  
            </div>
            <div class="h50p">
              <div class="song-time-container">
                <p class="song-title">Song Titleï¼š</p><span class="song-name">{{ latest_song.song_name }}</span>
              </div>
              <div class="song-time-container">
                <p class="upload-time">Upload Timeï¼š</p><span class="upload-time-value">{{ latest_song.upload_time }}</span>
              </div>
            </div>
          </div>
          {% else %}
          <div id="youtube-info" class="chart info-container">
            <div class="h50p">
              <p class="large-number">
                <!-- {{ latest_song.fame_indicator }} -->
                Below Expectations
              </p>
            </div>
            <div class="h50p">
              <div class="song-time-container">
                <p class="song-title">File Nameï¼š</p>
                <span class="song-name">
                  {{ latest_song.song_name }}
                  453.A Boogie Wit Da Hoodie - Still Think About You Prod by. Plug Studios NYC Official
                </span>
              </div>
              <div class="song-time-container">
                <p class="upload-time">Upload Timeï¼š</p>
                <span class="upload-time-value">
                  <!-- {{ latest_song.upload_time }} -->
                  {{ latest_song.upload_time }}
                </span>
              </div>
            </div>
          </div>
          {% endif %}

          <div id="youtube-doughnutChartContainer" class="chart-container chart">
            <canvas id="youtube-myDoughnutChart"></canvas>
          </div>
          <div id="youtube-barChartContainer" class="chart-container chart">
            <canvas id="youtube-myBarChart"></canvas>
          </div>
          <div id="youtube-countryChartContainer" class="chart-container chart">
            <canvas id="youtube-myCountryChart"></canvas>
          </div>
          <div class="text-chart">
            <p id="youtube-scenarioText" class="Comment"></p>
          </div>
        </div>
      </div>

      <!-- Spotify å€å¡Š -->
      <div class="analysis-content d-flex justify-content-center flex-wrap gap-3 color1" data-platform="spotify"
        style="display: none;">
        <div class="d-flex  flex-wrap color1 align-items-center justify-content-center">
          {% if latest_song.fame_indicator == "æœƒç´…å–”!" %}
          <div id="spotify-info" class="chart info-container">
            <div class="h50p">
              <p class="large-number">{{ latest_song.trending_days }}</p>
              <p class="description">days to 1 million views</p>
            </div>
            <div class="h50p">
              <div class="song-time-container">
                <p class="song-title">Song Titleï¼š</p><span class="song-name">{{ latest_song.song_name }}</span>
              </div>
              <div class="song-time-container">
                <p class="upload-time">Upload Timeï¼š</p><span class="upload-time-value">{{ latest_song.upload_time
                  }}</span>
              </div>
            </div>
          </div>
          {% else %}
          <div id="spotify-info" class="chart info-container">
            <div class="h50p">
              <p class="large-number">
                <!-- {{ latest_song.fame_indicator }} -->
                Below expectations
              </p>
            </div>
            <div class="h50p">
              <div class="song-time-container">
                <p class="song-title">File Nameï¼š</p><span class="song-name">{{ latest_song.song_name }}</span>
              </div>
              <div class="song-time-container">
                <p class="upload-time">Upload Timeï¼š</p>
                <span class="upload-time-value">
                  <!-- {{ latest_song.upload_time }} -->
                  {{ latest_song.upload_time }}
                </span>
              </div>
            </div>
          </div>
          {% endif %}
          <div id="spotify-doughnutChartContainer" class="chart-container chart">
            <canvas id="spotify-myDoughnutChart"></canvas>
          </div>
          <div id="spotify-barChartContainer" class="chart-container chart">
            <canvas id="spotify-myBarChart"></canvas>
          </div>
          <div id="spotify-countryChartContainer" class="chart-container chart">
            <canvas id="spotify-myCountryChart"></canvas>
          </div>
          <div class="text-chart">
            <p id="spotify-scenarioText" class="Comment"></p>
          </div>
        </div>
      </div>

      <!-- Apple Music å€å¡Š -->
      <div class="analysis-content d-flex justify-content-center flex-wrap gap-3 color1" data-platform="apple-music"
        style="display: none;">
        <div class="d-flex  flex-wrap color1 align-items-center justify-content-center">
          {% if latest_song.fame_indicator == "æœƒç´…å–”!" %}
          <div id="apple-music-info" class="chart info-container">
            <div class="h50p">
              <p class="large-number">{{ latest_song.trending_days }}</p>
              <p class="description">days to 1 million views</p>
            </div>
            <div class="h50p">
              <div class="song-time-container">
                <p class="song-title">Song Titleï¼š</p><span class="song-name">{{ latest_song.song_name }}</span>
              </div>
              <div class="song-time-container">
                <p class="upload-time">Upload Timeï¼š</p><span class="upload-time-value">{{ latest_song.upload_time
                  }}</span>
              </div>
            </div>
          </div>
          {% else %}
          <div id="apple-music-info" class="chart info-container">
            <div class="h50p">
              <p class="large-number">
                <!-- {{ latest_song.fame_indicator }} -->
                Below expectations
              </p>
            </div>
            <div class="h50p">
              <div class="song-time-container">
                <p class="song-title">File Nameï¼š</p><span class="song-name">{{ latest_song.song_name }}</span>
              </div>
              <div class="song-time-container">
                <p class="upload-time">Upload Timeï¼š</p>
                <span class="upload-time-value">
                  <!-- {{ latest_song.upload_time }} -->
                  {{ latest_song.upload_time }}
                </span>
              </div>
            </div>
          </div>
          {% endif %}
          <div id="apple-music-doughnutChartContainer" class="chart-container chart">
            <canvas id="apple-music-myDoughnutChart"></canvas>
          </div>
          <div id="apple-music-barChartContainer" class="chart-container chart">
            <canvas id="apple-music-myBarChart"></canvas>
          </div>
          <div id="apple-music-countryChartContainer" class="chart-container chart">
            <canvas id="apple-music-myCountryChart"></canvas>
          </div>
          <div class="full-width text-chart">
            <p id="apple-music-scenarioText" class="Comment"></p>
          </div>
        </div>
      </div>

      <!-- TIDAL å€å¡Š -->
      <div class="analysis-content d-flex justify-content-center flex-wrap gap-3 color1" data-platform="tidal"
        style="display: none;">
        <div class="d-flex  flex-wrap color1 align-items-center justify-content-center">
          {% if latest_song.fame_indicator == "æœƒç´…å–”!" %}
          <div id="tidal-info" class="chart info-container">
            <div class="h50p">
              <p class="large-number">{{ latest_song.trending_days }}</p>
              <p class="description">days to 1 million views</p>
            </div>
            <div class="h50p">
              <div class="song-time-container">
                <p class="song-title">Song Titleï¼š</p><span class="song-name">{{ latest_song.song_name }}</span>
              </div>
              <div class="song-time-container">
                <p class="upload-time">Upload Timeï¼š</p><span class="upload-time-value">{{ latest_song.upload_time
                  }}</span>
              </div>
            </div>
          </div>
          {% else %}
          <div id="tidal-info" class="chart info-container">
            <div class="h50p">
              <p class="large-number">
                <!-- {{ latest_song.fame_indicator }} -->
                Below expectations
              </p>
            </div>
            <div class="h50p">
              <div class="song-time-container">
                <p class="song-title">File Nameï¼š</p><span class="song-name">{{ latest_song.song_name }}</span>
              </div>
              <div class="song-time-container">
                <p class="upload-time">Upload Timeï¼š</p>
                <span class="upload-time-value">
                  <!-- {{ latest_song.upload_time }} -->
                  {{ latest_song.upload_time }}
                </span>
              </div>
            </div>
          </div>
          {% endif %}
          <div id="tidal-doughnutChartContainer" class="chart-container chart">
            <canvas id="tidal-myDoughnutChart"></canvas>
          </div>
          <div id="tidal-barChartContainer" class="chart-container chart">
            <canvas id="tidal-myBarChart"></canvas>
          </div>
          <div id="tidal-countryChartContainer" class="chart-container chart">
            <canvas id="tidal-myCountryChart"></canvas>
          </div>
          <div class="full-width text-chart">
            <p id="tidal-scenarioText" class="Comment"></p>
          </div>
        </div>
      </div>

      <!-- Amazon Music å€å¡Š -->
      <div class="analysis-content d-flex justify-content-center flex-wrap gap-3 color1" data-platform="amazon-music"
        style="display: none;">
        <div class="d-flex  flex-wrap color1 align-items-center justify-content-center">
          {% if latest_song.fame_indicator == "æœƒç´…å–”!" %}
          <div id="samazon-music-info" class="chart info-container">
            <div class="h50p">
              <p class="large-number">{{ latest_song.trending_days }}</p>
              <p class="description">days to 1 million views</p>
            </div>
            <div class="h50p">
              <div class="song-time-container">
                <p class="song-title">Song Titleï¼š</p><span class="song-name">{{ latest_song.song_name }}</span>
              </div>
              <div class="song-time-container">
                <p class="upload-time">Upload Timeï¼š</p><span class="upload-time-value">{{ latest_song.upload_time
                  }}</span>
              </div>
            </div>
          </div>
          {% else %}
          <div id="amazon-music-info" class="chart info-container">
            <div class="h50p">
              <p class="large-number">
                <!-- {{ latest_song.fame_indicator }} -->
                Below expectations
              </p>
            </div>
            <div class="h50p">
              <div class="song-time-container">
                <p class="song-title">File Nameï¼š</p><span class="song-name">{{ latest_song.song_name }}</span>
              </div>
              <div class="song-time-container">
                <p class="upload-time">Upload Timeï¼š</p>
                <span class="upload-time-value">
                  <!-- {{ latest_song.upload_time }} -->
                  {{ latest_song.upload_time }}
                </span>
              </div>
            </div>
          </div>
          {% endif %}
          <div id="amazon-music-doughnutChartContainer" class="chart-container chart">
            <canvas id="amazon-music-myDoughnutChart"></canvas>
          </div>
          <div id="amazon-music-barChartContainer" class="chart-container chart">
            <canvas id="amazon-music-myBarChart"></canvas>
          </div>
          <div id="amazon-music-countryChartContainer" class="chart-container chart">
            <canvas id="amazon-music-myCountryChart"></canvas>
          </div>
          <div class="full-width text-chart">
            <p id="amazon-music-scenarioText" class="Comment"></p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer class="footer bc32 d-flex justify-content-between color1">
    <div class="d-flex flex-column justify-content-center text-start align-items m100">
      <div class="footer-text  w-auto">emailï¼šwhalesignal@gmail.com</div>
      <div class="footer-text  w-auto">producerï¼šEric Wang, Ben Chan, Andrew Chang, Alice Lu, Joseph Fang, Jin Chang
      </div>
    </div>
    <div class="d-flex align-items-center justify-content-center ">
      <a href="" class="footer-btn animate__animated">
        <img src="https://cdn-icons-png.flaticon.com/512/15047/15047435.png" alt="fb-icon" class="fb w50 h50">
      </a>
      <a href="" class="footer-btn animate__animated">
        <img src="https://cdn-icons-png.flaticon.com/512/15707/15707749.png" alt="ig-icon" class="ig w50 h50">
      </a>
      <a href="" class="footer-btn animate__animated">
        <img src="https://cdn-icons-png.flaticon.com/512/5969/5969020.png" alt="x-icon" class="x w50 h50">
      </a>
    </div>
  </footer>
  <!-- æœƒå“¡ -->
  <script>
    // å‡è¨­æœ‰å€‹è®Šæ•¸ä¾†åˆ¤æ–·æœƒå“¡ç‹€æ…‹
const isPaidMember = localStorage.getItem("permission");
if (isPaidMember == 0) {
  console.log("éä»˜è²»æœƒå“¡è²·ä¸èµ·å“ˆå“ˆ")
  document.querySelectorAll('.chart-container').forEach(el => {
el.classList.add('non-member');
});
document.querySelectorAll('.history-btn').forEach(el => {
el.classList.add('non-member');
});
document.querySelectorAll('.text-chart').forEach(el => {
el.classList.add('non-member');
});
document.querySelectorAll('.amazon-btn').forEach(el => {
el.classList.add('non-member');
});
document.querySelectorAll('.tidal-btn').forEach(el => {
el.classList.add('non-member');
});
document.querySelectorAll('.am-btn').forEach(el => {
el.classList.add('non-member');
});
document.querySelectorAll('.sptf-btn').forEach(el => {
el.classList.add('non-member');
});
} else {
  console.log("æ˜¯ä»˜è²»æœƒå“¡å“ˆå“ˆç›¤å­")
   // ç§»é™¤æ‰€æœ‰ .chart-container, .text-chart, .amazon-btn, .tidal-btn, .am-btn, .sptf-btn çš„ non-member é¡åˆ¥
document.querySelectorAll('.chart-container').forEach(el => {
el.classList.remove('non-member');
});
document.querySelectorAll('.history-btn').forEach(el => {
  el.classList.remove('non-member');});
document.querySelectorAll('.text-chart').forEach(el => {
el.classList.remove('non-member');
});
document.querySelectorAll('.amazon-btn').forEach(el => {
el.classList.remove('non-member');
});
document.querySelectorAll('.tidal-btn').forEach(el => {
el.classList.remove('non-member');
});
document.querySelectorAll('.am-btn').forEach(el => {
el.classList.remove('non-member');
});
document.querySelectorAll('.sptf-btn').forEach(el => {
el.classList.remove('non-member');
});
}
  </script>


  <!-- é«˜åº¦ -->
  <script>
    function adjustMainContentHeight() {
      const mainContent = document.querySelector('.main-content');
      const activeContent = document.querySelector('.analysis-content.active');
      const textChart = activeContent ? activeContent.querySelector('.text-chart') : null;

      if (mainContent && activeContent) {
        let newHeight = activeContent.scrollHeight; // å…ˆå– activeContent é«˜åº¦

        // if (textChart) {
        //   newHeight += textChart.scrollHeight; // å†åŠ ä¸Š text-chart çš„é«˜åº¦
        // }

        console.log("è¨­å®š mainContent é«˜åº¦:", newHeight);
        mainContent.style.height = newHeight + 155 + 'px';
      } else {
        console.log("æ‰¾ä¸åˆ° .analysis-content.active æˆ– .text-chart");
      }
    }


    // ç¢ºä¿ DOM è¼‰å…¥å¾ŒåŸ·è¡Œ
    document.addEventListener('DOMContentLoaded', () => {
      console.log("DOMContentLoaded fired");
      adjustMainContentHeight();
    });

    // ç¢ºä¿æ‰€æœ‰è³‡æºè¼‰å…¥å¾ŒåŸ·è¡Œ
    window.addEventListener('load', () => {
      console.log("Window load event fired");
      adjustMainContentHeight();
    });

    // ç›£è½è¦–çª—å¤§å°è®ŠåŒ–
    window.addEventListener('resize', () => {
      console.log("Window resized");
      adjustMainContentHeight();
    });

    // å¦‚æœ `canvas` æˆ–å…¶ä»–å…§å®¹æ˜¯é€é JS å‹•æ…‹è¼‰å…¥ï¼Œå»¶é²èª¿æ•´é«˜åº¦
    setTimeout(() => {
      console.log("Delayed height adjustment");
      adjustMainContentHeight();
    }, 1000);

    // ä½¿ç”¨ `MutationObserver` ç›£è½ DOM è®Šå‹•ï¼ˆä¾‹å¦‚ `.analysis-content` åˆ‡æ›ï¼‰
    const observer = new MutationObserver((mutationsList) => {
      console.log("DOM Mutation detected:", mutationsList);
      adjustMainContentHeight();
    });

    // ç›£è½ `.main-content` å…§éƒ¨çš„è®ŠåŒ–
    const mainContent = document.querySelector('.main-content');
    if (mainContent) {
      observer.observe(mainContent, { childList: true, subtree: true });
    } else {
      console.log("main-content not found for MutationObserver");
    }
  </script>
  <!-- æ­·å²é¸å–® -->
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const toggleButton = document.getElementById("toggleHistory");
      const historyPanel = document.getElementById("historyPanel");

      // åˆ‡æ›é¢æ¿é¡¯ç¤º/éš±è—
      toggleButton.addEventListener("click", function (event) {
        historyPanel.classList.toggle("active");
        toggleButton.classList.toggle("active");
        event.stopPropagation(); // é˜²æ­¢é»æ“ŠæŒ‰éˆ•æ™‚äº‹ä»¶å†’æ³¡åˆ° document
      });

      // é»æ“Šé é¢å…¶ä»–åœ°æ–¹æ™‚é—œé–‰é¢æ¿
      document.addEventListener("click", function (event) {
        // å¦‚æœé»æ“Šçš„åœ°æ–¹æ—¢ä¸æ˜¯ toggleButton ä¹Ÿä¸æ˜¯ historyPanel
        if (!historyPanel.contains(event.target) && !toggleButton.contains(event.target)) {
          historyPanel.classList.remove("active");
          toggleButton.classList.remove("active");
        }
      });
    });
  </script>
  <!-- å¹³å°åˆ‡æ›è…³æœ¬ -->
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const switchButtons = document.querySelectorAll(".yt-btn-block");
      const analysisContents = document.querySelectorAll(".analysis-content");

      let activePlatform = "youtube"; // é è¨­ Youtube
      document.querySelector(`[data-platform="${activePlatform}"]`).classList.add("active");
      document.querySelector(`.analysis-content[data-platform="${activePlatform}"]`).classList.add("active");

      switchButtons.forEach(button => {
        button.addEventListener("click", function () {
          const selectedPlatform = this.getAttribute("data-platform");
          if (selectedPlatform !== activePlatform) {
            document.querySelector(".yt-btn-block.active").classList.remove("active");
            this.classList.add("active");
            document.querySelector(".analysis-content.active").classList.remove("active");
            document.querySelector(`.analysis-content[data-platform="${selectedPlatform}"]`).classList.add("active");
            activePlatform = selectedPlatform;
          }
        });
      });
    });
  </script>
  <!-- login -->
  <script src="{{url_for('static', filename='javascript/homepage.js')}}"></script>
   
  <!-- <script>
    document.addEventListener('DOMContentLoaded', function () {
    const fileInput = document.getElementById('file-input');
    const fileNameDisplay = document.getElementById('file-name');
    const dropArea = document.getElementById('drop-area');

    // è™•ç†æª”æ¡ˆé¸æ“‡
    fileInput.addEventListener('change', function() {
        const file = fileInput.files[0];
        if (file) {
            fileNameDisplay.textContent = file.name;
            fileNameDisplay.classList.add('active');  // **æ–°å¢ active class**
        } else {
            fileNameDisplay.textContent = "Drop music files here, or click to select";
            fileNameDisplay.classList.remove('active');  // **ç§»é™¤ active class**
        }
    });
     // ç¢ºä¿é¸å–åˆ°æŒ‰éˆ•
    const loginButton = document.getElementById("user-account");
    if (!loginButton) {
         console.error("âŒ loginButton not found!");
         return;  // å¦‚æœæ‰¾ä¸åˆ°æŒ‰éˆ•ï¼Œå°±åœæ­¢åŸ·è¡Œ
     }
 
    // æª¢æŸ¥ localStorage æ˜¯å¦æœ‰å„²å­˜çš„ username
    const username = localStorage.getItem("username");
    if (username) {
        // âœ… **ä½¿ç”¨è€…å·²ç™»å…¥ï¼ŒæŒ‰éˆ•è®Šæˆ username**
        loginButton.textContent = username;
        loginButton.href = "#";  // é¿å…è·³è½‰

        // âœ… **ç™»å‡ºåŠŸèƒ½**
        loginButton.addEventListener("click", function () {
            event.preventDefault();
            const confirmLogout = confirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ");
            if (confirmLogout) {
                localStorage.removeItem("username");  // æ¸…é™¤ç™»å…¥è³‡è¨Š
                
                // âœ… **ä¸åˆ·æ–°é é¢ï¼Œç›´æ¥æ›´æ–° UI**
                loginButton.textContent = "Login";
                loginButton.removeAttribute("href"); // **ç§»é™¤ hrefï¼Œé¿å…é»æ“Šå¾Œè·³è½‰**
                
                // âœ… **åˆªé™¤ç™»å‡ºäº‹ä»¶ï¼Œé˜²æ­¢ä»ç„¶åŸ·è¡Œ logout**
                const newLoginButton = loginButton.cloneNode(true);
                newLoginButton.href = "http://127.0.0.1:5000/log_in";  // **æ­£ç¢ºè¨­å®š href**
                loginButton.replaceWith(newLoginButton);
            }
        });
    } else {
        // âœ… **ä½¿ç”¨è€…æœªç™»å…¥æ™‚ï¼ŒæŒ‰éˆ•ç¶­æŒ "Login"**
        loginButton.textContent = "Login";
        loginButton.href = "http://127.0.0.1:5000/log_in";  // æ­£ç¢ºçš„ç™»å…¥é€£çµ
        // **ç¢ºä¿ç™»å‡ºç›£è½å™¨è¢«ç§»é™¤**
        loginButton.replaceWith(loginButton.cloneNode(true));
    }
  </script> -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const loginButtons = document.querySelectorAll(".user-account");

    if (loginButtons.length === 0) {
         console.error("âŒ user-account not found!");
         return;
    }
 
    const username = localStorage.getItem("username");

    if (username) {
        // âœ… ä½¿ç”¨è€…å·²ç™»å…¥ï¼Œè®Šæ›´æŒ‰éˆ•ç‚º username ä¸¦ç¶å®šç™»å‡ºåŠŸèƒ½
        loginButtons.forEach(button => {
            button.textContent = username;
            button.href = "#"; // é¿å…é»æ“Šå¾Œè·³è½‰
            button.removeEventListener("click", handleLoginClick); // **å…ˆç§»é™¤ç™»éŒ„äº‹ä»¶**
            button.addEventListener("click", handleLogoutClick); // **ç¶å®šç™»å‡º**
        });

    } else {
        // âœ… ä½¿ç”¨è€…æœªç™»å…¥æ™‚ï¼ŒæŒ‰éˆ•è®Šå› Login ä¸¦æŒ‡å‘ç™»å…¥é 
        loginButtons.forEach(button => {
            button.textContent = "Login";
            button.href = "http://127.0.0.1:5000/log_in";
            button.removeEventListener("click", handleLogoutClick); // **å…ˆç§»é™¤ç™»å‡ºäº‹ä»¶**
            button.addEventListener("click", handleLoginClick); // **ç¶å®šç™»å…¥**
        });
    }

    // âœ… ç™»å‡ºåŠŸèƒ½ï¼ˆç¢ºèªæ˜¯å¦è¦ç™»å‡ºï¼‰
    function handleLogoutClick(event) {
        event.preventDefault();
        const confirmLogout = confirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ");
        if (confirmLogout) {
            localStorage.removeItem("username");

            // **ç™»å‡ºå¾Œæ¢å¾©æˆ Login ç‹€æ…‹**
            loginButtons.forEach(button => {
                button.textContent = "Login";
                button.href = "http://127.0.0.1:5000/log_in";
                button.removeEventListener("click", handleLogoutClick); // **ç§»é™¤ç™»å‡ºç›£è½**
                button.addEventListener("click", handleLoginClick); // **æ¢å¾©ç™»å…¥ç›£è½**
            });
            window.location.href = "/";
        }
    }

    // âœ… ç™»å…¥åŠŸèƒ½ï¼ˆé»æ“Šæ™‚å‰å¾€ç™»å…¥é é¢ï¼‰
    function handleLoginClick(event) {
        // é€™è£¡ä¸éœ€è¦ `preventDefault()`ï¼Œå› ç‚ºæˆ‘å€‘å¸Œæœ›å®ƒèƒ½å¤ è·³è½‰
        window.location.href = "http://127.0.0.1:5000/log_in";
    }
});
  </script>
  <!-- å¾Œç«¯ç”¢ç”Ÿçš„ JSON ç‰©ä»¶ (ç›´æ¥æ³¨å…¥ï¼Œä¸éœ€å†è§£æ) -->
  <script>
    const chartData = {{ data_str| safe }};
    console.log("Parsed chartData:", chartData);

    // å°‡ scenario æ–‡å­—å¡«å…¥å„å¹³å°
    const platforms = ["youtube", "spotify", "apple-music", "tidal", "amazon-music"];
    platforms.forEach(platform => {
      if (chartData[platform]) {
        document.getElementById(`${platform}-scenarioText`).innerText = chartData[platform].scenario;
      }
    });
  </script>

  <!-- å»ºç«‹åœ–è¡¨ (åŒ…å« zoom æ’ä»¶èˆ‡å‹•ç•«) -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Zoom æ’ä»¶ (Bar)
      const progressiveZoomBarPlugin = {
        id: 'progressiveZoomBarPlugin',
        afterDatasetDraw(chart, args, options) {
          const ctx = chart.ctx;
          const meta = chart.getDatasetMeta(args.index);
          meta.data.forEach((bar) => {
            try {
              const zoom = bar._zoomProgress || 0;
              if (zoom > 0) {
                const x = Math.min(bar.base, bar.x);
                const width = Math.abs(bar.x - bar.base);
                const centerY = bar.y;
                const newHeight = bar.height + zoom;
                const newY = centerY - newHeight / 2;
                ctx.save();
                let bg = bar.options.backgroundColor;
                if (Array.isArray(bg)) {
                  bg = bg[bar.index] || bg[0];
                }
                ctx.fillStyle = bg;
                ctx.fillRect(x, newY, width, newHeight);
                ctx.restore();
              }
            } catch (e) {
              console.error(e);
            }
          });
        }
      };
      function animateZoomBar(chart, zoomAmount = 10, animationSpeed = 0.05) {
        const activeElements = chart.getActiveElements();
        let updated = false;
        chart.data.datasets.forEach((dataset, datasetIndex) => {
          const meta = chart.getDatasetMeta(datasetIndex);
          meta.data.forEach((bar) => {
            const isActive = activeElements.some(a => a.element === bar);
            const target = isActive ? zoomAmount : 0;
            if (bar._zoomProgress === undefined) {
              bar._zoomProgress = 0;
            }
            const diff = target - bar._zoomProgress;
            if (Math.abs(diff) > 0.1) {
              bar._zoomProgress += diff * animationSpeed;
              updated = true;
            } else {
              bar._zoomProgress = target;
            }
          });
        });
        if (updated) {
          chart.draw();
          requestAnimationFrame(() => animateZoomBar(chart, zoomAmount, animationSpeed));
        }
      }

      // Zoom æ’ä»¶ (Doughnut)
      const progressiveZoomArcPlugin = {
        id: 'progressiveZoomArcPlugin',
        beforeDatasetDraw(chart, args, options) {
          const meta = chart.getDatasetMeta(args.index);
          meta.data.forEach((arc) => {
            if (!arc.$originalOuterRadius) {
              arc.$originalOuterRadius = arc.outerRadius;
            }
            const zoom = arc._zoomProgress || 0;
            arc.outerRadius = arc.$originalOuterRadius + zoom;
          });
        }
      };
      function animateZoomArc(chart, zoomAmount = 10, animationSpeed = 0.05) {
        const activeElements = chart.getActiveElements();
        let updated = false;
        chart.data.datasets.forEach((dataset, datasetIndex) => {
          const meta = chart.getDatasetMeta(datasetIndex);
          meta.data.forEach((arc) => {
            const isActive = activeElements.some(a => a.element === arc);
            const target = isActive ? zoomAmount : 0;
            if (arc._zoomProgress === undefined) {
              arc._zoomProgress = 0;
            }
            const diff = target - arc._zoomProgress;
            if (Math.abs(diff) > 0.1) {
              arc._zoomProgress += diff * animationSpeed;
              updated = true;
            } else {
              arc._zoomProgress = target;
            }
          });
        });
        if (updated) {
          chart.draw();
          requestAnimationFrame(() => animateZoomArc(chart, zoomAmount, animationSpeed));
        }
      }

      // æ ¹æ“š chartData å»ºç«‹å„å¹³å°çš„åœ–è¡¨
      const platforms = ["youtube", "spotify", "apple-music", "tidal", "amazon-music"];
      platforms.forEach(platform => {
        if (chartData[platform]) {
          const dataObj = chartData[platform];
          // Doughnut (æ€§åˆ¥åˆ†å¸ƒ)
          const doughnutCtx = document.getElementById(`${platform}-myDoughnutChart`).getContext('2d');
          const doughnutConfig = {
            type: 'doughnut',
            data: {
              labels: dataObj.gender.categories,
              datasets: [{
                label: 'GENDER',
                data: dataObj.gender.percentages,
                backgroundColor: ['#31c7ba', '#FF6F91', '#ffea4a'],
                hoverOffset: 10,
                borderColor: 'rgba(255, 255, 255, 0.5)', // è¨­å®šé‚Šæ¡†é¡è‰²ï¼ˆé€æ˜é»‘è‰²ï¼‰
                borderWidth: 1,
                hoverRadius: 10, // è¨­å®š hover å€åŸŸçš„å¤§å°
                hitRadius: 15   // è¨­å®šè§¸åŠç¯„åœ

              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              cutout: '65%',
              layout: { padding: 15 },
              plugins: {
                legend: {
                  position: 'top', labels: {
                    color: '#EEEEEE', font: {
                      family: 'Rajdhani'
                      // è¨­å®šåœ–ä¾‹æ–‡å­—å¤§å°
                    }
                  }
                },
                title: {
                  display: true, text: 'GENDER', color: '#EEEEEE', padding: {
                    top: 0,   // èª¿æ•´æ¨™é¡Œèˆ‡åœ–è¡¨çš„é–“è·

                  }, font: {
                    size: 16,
                    family: 'Michroma', // å­—å‹
                    weight: 'bold' // å­—é‡
                  }
                }
              },
              onHover: (event, activeElements, chart) => { animateZoomArc(chart, 10, 0.05); }
            },
            plugins: [progressiveZoomArcPlugin]
          };
          new Chart(doughnutCtx, doughnutConfig);

          // Bar (å¹´é½¡åˆ†å¸ƒ)
          const barCtx = document.getElementById(`${platform}-myBarChart`).getContext('2d');
          const barConfig = {
            type: 'bar',
            data: {
              labels: dataObj.age.categories,
              datasets: [{
                label: 'AGE',
                data: dataObj.age.percentages,
                backgroundColor: [
                  '#31c7ba',
                  '#53d3a3',       // è—ç¶ è‰²
                  '#87e391',       // è—è‰²
                  '#beef7e',       // é»ƒè‰²
                  '#f9f871',       // ç´…è‰²
                  '#ff8945',
                  '#FF6F91',    // ç´«è‰²
                  '#ce7fd6'        // æ©™è‰² // é¡è‰²8
                ],
                borderColor: [
                  'rgba(255, 255, 255, 0.5)'
                ],
                borderWidth: 1
              }]
            },
            options: {
              indexAxis: 'y',
              responsive: true,
              maintainAspectRatio: false,
              layout: { padding: 15 },
              scales: {
                x: { display: false },
                y: {
                  ticks: {
                    color: '#EEEEEE', font: {
                      size: 16,
                      family: 'Rajdhani' // 1.25rem ä»£æ›¿ 20px
                    }
                  }
                }
              },
              plugins: {
                legend: { display: false },
                title: {
                  display: true, text: 'AGE', color: '#EEEEEE', font: {
                    size: 16,
                    family: 'Michroma', // å­—å‹
                    weight: 'bold' // å­—é‡
                  }
                }
              },
              onHover: (event, activeElements, chart) => { animateZoomBar(chart, 10, 0.05); }
            },
            plugins: [progressiveZoomBarPlugin]
          };
          new Chart(barCtx, barConfig);

          // Bar (åœ°å€åˆ†å¸ƒ)
          const countryCtx = document.getElementById(`${platform}-myCountryChart`).getContext('2d');
          const countryConfig = {
            type: 'bar',
            data: {
              labels: dataObj.country.categories,
              datasets: [{
                label: 'AREA',
                data: dataObj.country.percentages,
                backgroundColor: [
                  '#87e391',       // è—è‰²
                  '#beef7e',       // é»ƒè‰²
                  '#f9f871',       // ç´…è‰²
                  '#ff8945',
                  '#FF6F91',    // ç´«è‰²
                  '#ce7fd6'        // æ©™è‰² // é¡è‰²8
                ],
                borderColor: ['rgba(255,255,255,0.5)'],
                borderWidth: 1
              }]
            },
            options: {
              indexAxis: 'y',
              responsive: true,
              maintainAspectRatio: false,
              layout: { padding: 15 },
              scales: {
                x: { display: false },
                y: {
                  ticks: {
                    color: '#EEEEEE', font: {
                      size: 16,
                      family: 'Rajdhani'
                    }
                  }
                }
              },
              plugins: {
                legend: { display: false },
                title: {
                  display: true, text: 'AREA', color: '#EEEEEE', font: {
                    size: 16,
                    family: 'Michroma', // å­—å‹
                    weight: 'bold' // å­—é‡
                  }
                },
                tooltip: {
                  position: 'nearest',
                  xAlign: 'right',
                  yAlign: 'center',
                  callbacks: {
                    label: function (context) {
                      const value = context.parsed.x;
                      return `${context.dataset.label}: ${value}%`;
                    }
                  }
                }
              },
              onHover: (event, activeElements, chart) => { animateZoomBar(chart, 10, 0.05); }
            },
            plugins: [progressiveZoomBarPlugin]
          };
          new Chart(countryCtx, countryConfig);
        }
      });
    });
  </script>
  <script>
    function redirectToAnalysis(recordId) {
        window.location.href = `/analysis/${recordId}`;
    }
  </script>
</body>
</html>